
╔═══════════════════════════════════════════════════════════════╗
║               FMaaS Orchestrator Server                       ║
╚═══════════════════════════════════════════════════════════════╝

Starting server on http://0.0.0.0:8080

Available endpoints:
  GET  /              - Health check
  GET  /status        - Get orchestrator status
  POST /deploy        - Deploy initial tasks
  POST /run           - Run inference
  POST /add-task      - Add task at runtime
  POST /cleanup       - Cleanup devices

Press Ctrl+C to stop

INFO:     Started server process [2658554]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
INFO:     127.0.0.1:43960 - "GET / HTTP/1.1" 200 OK

================================================================================
DEPLOYMENT
================================================================================

[Server] Loading config: runtime
[Server] Generating trace: lmsyschat (rate=10, duration=60s)
/home/hshastri_umass_edu/.conda/envs/fmtk/lib/python3.10/site-packages/torch/cuda/__init__.py:63: FutureWarning: The pynvml package is deprecated. Please install nvidia-ml-py instead. If you did not install pynvml directly, please report this to the maintainers of the package that installed pynvml for you.
  import pynvml  # type: ignore[import]
[Server] Generated 600 requests
[Server] Planning deployment...
[Orchestrator] Saved deployment plan to /project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/clipper-ha/10/deployment_plan.json (scheduler=clipper-ha)
[Server] Routing trace...
task_routes: {'ecgclass': [('site2', '10.100.20.53:8000', 'momentbase', 10.0)]}
task_totals: {'ecgclass': 10.0}
incoming_counts: {'ecgclass': 600}
trace_duration: 60.0
600
Connecting to broker.emqx.io:8084 ...
Orchestrator connected to MQTT broker
Publishing deployments + requests to all sites...
[Orchestrator] Sent 600 requests (total=600)
[MQTT] Sent deployment to site2 (output_dir=/project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/clipper-ha/10)
Deploytime ACK from site2: {'site': 'site2', 'deploymentstatus': [{'status': 'loaded_momentbase', 'logger_summary': "{'load_backbone': {'wall time': 3512.461637001252, 'gpu time': 3512.547607421875, 'gpu peak': 455.474688, 'cpu dRSS': 544.538624}, 'add_decoder_ecgclass_momentbase_mlp': {'wall time': 14.109001000178978, 'gpu time': 14.142463684082031, 'gpu peak': 455.871488, 'cpu dRSS': 0.524288}}"}]}
[MQTT] Sent request chunk [0:3000] to site2
[MQTT] All 600 requests sent to site2
Waiting for deployment ACKs from 1 sites...
Deployment phase complete. Results in /project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/clipper-ha/10

[Server] Deployment complete! Results in /project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/clipper-ha/10
INFO:     127.0.0.1:20656 - "POST /deploy HTTP/1.1" 200 OK

================================================================================
RUNTIME
================================================================================

INFO:     127.0.0.1:32164 - "POST /run HTTP/1.1" 200 OK
[Server] Starting inference in background thread...
Connecting to broker.emqx.io:8084 ...
Orchestrator connected to MQTT broker
Runtime start published to fmaas/runtime/start/site/site2
[Orchestrator] Runtime inference triggered (continuous mode)

[Server] Inference triggered (continuous mode - still running on site managers)

[Server] Adding task: gestureclass
         Type: classification, Workload: 8.0
         Elapsed time: 10.0s
[Orchestrator] Loading state from: /project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/clipper-ha/10/deployment_plan.json
[Orchestrator] Planned 'gestureclass' with accuracy_mode=True. Diffs: [DeploymentDiff(action='add_full', site_manager='site2', server_name='device1', backbone='momentlarge', ip='10.100.20.53:8010', device_type='NVIDIA A16', new_decoders=[{'task': 'gestureclass', 'type': 'classification', 'path': 'gestureclass_momentlarge_mlp'}], full_deployment={'device': '10.100.20.53:8010', 'device_name': 'device1', 'device_type': 'NVIDIA A16', 'backbone': 'momentlarge', 'decoders': [{'task': 'gestureclass', 'type': 'classification', 'path': 'gestureclass_momentlarge_mlp'}], 'tasks': {'gestureclass': {'type': 'classification', 'total_requested_workload': 8.0, 'request_per_sec': 8.0}}, 'util': 0.449815, 'mem': 16000})]
[MQTT] Published /add to site2 (server=device1)
[Orchestrator] Waiting for ACKs from 1 site(s)...
Deploytime ACK from site2: {'site': 'site2', 'add': True, 'status': 'started'}
[Orchestrator] All ACKs received for diff operation.
[Orchestrator] Saved updated state to /project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/clipper-ha/10/deployment_plan.json
  ✓ Deployment diff applied.
    add_full: device1 @ site2

[Server] Generating workload for new task (duration=50.0s, offset=10.0s)...
[Server] Using req_id_offset=600
[Server] Applied time_offset=10.0s to 400 requests
[Server] Generated 400 requests (req_ids 600 to 999)
[Server] Time range: 10.0s to 60.0s
task_routes: {'gestureclass': [('site2', '10.100.20.53:8010', 'momentlarge', 8.0)]}
task_totals: {'gestureclass': 8.0}
incoming_counts: {'gestureclass': 400}
trace_duration: 50.0
400
[Server] Sending new workload to site managers...
[Orchestrator] Sending 400 new requests (total=1000)
[MQTT] Reusing existing MQTT connection (fast path)
[MQTT] Sent chunk [0:3000] to site2
[MQTT] All new requests sent.
  ✓ Workload sent!
INFO:     127.0.0.1:60526 - "POST /add-task HTTP/1.1" 200 OK
Runtime ACK from site2Runtime inference complete.

INFO:     127.0.0.1:60530 - "POST /wait HTTP/1.1" 200 OK

================================================================================
CLEANUP
================================================================================

Connecting to broker.emqx.io:8084 ...
Orchestrator connected to MQTT broker
Cleanup signal published to fmaas/cleanup/site/site2
Cleanup ACK from site2
Cleanup complete. All device servers killed.

[Server] Cleanup complete!
INFO:     127.0.0.1:24794 - "POST /cleanup HTTP/1.1" 200 OK

================================================================================
CLEANUP
================================================================================

INFO:     127.0.0.1:51128 - "POST /cleanup HTTP/1.1" 400 Bad Request
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [2658554]
