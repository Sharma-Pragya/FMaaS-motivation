
╔═══════════════════════════════════════════════════════════════╗
║               FMaaS Orchestrator Server                       ║
╚═══════════════════════════════════════════════════════════════╝

Starting server on http://0.0.0.0:8080

Available endpoints:
  GET  /              - Health check
  GET  /status        - Get orchestrator status
  POST /deploy        - Deploy initial tasks
  POST /run           - Run inference
  POST /add-task      - Add task at runtime
  POST /cleanup       - Cleanup devices

Press Ctrl+C to stop

INFO:     Started server process [2805489]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
INFO:     127.0.0.1:30502 - "GET / HTTP/1.1" 200 OK

================================================================================
DEPLOYMENT
================================================================================

[Server] Loading config: runtime
[Server] Generating trace: lmsyschat (rate=10, duration=360s)
/home/hshastri_umass_edu/.conda/envs/fmtk/lib/python3.10/site-packages/torch/cuda/__init__.py:63: FutureWarning: The pynvml package is deprecated. Please install nvidia-ml-py instead. If you did not install pynvml directly, please report this to the maintainers of the package that installed pynvml for you.
  import pynvml  # type: ignore[import]
[Server] Generated 3600 requests
[Server] Planning deployment...
[Orchestrator] Saved deployment plan to /project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/fmaas_share/10/deployment_plan.json (scheduler=fmaas_share)
[Server] Routing trace...
task_routes: {'ecgclass': [('site2', '10.100.20.53:8000', 'momentbase', 10.0)]}
task_totals: {'ecgclass': 10.0}
incoming_counts: {'ecgclass': 3600}
trace_duration: 360.0
3600
Connecting to broker.emqx.io:8084 ...
Orchestrator connected to MQTT broker
Publishing deployments + requests to all sites...
[Orchestrator] Sent 3600 requests (total=3600)
[MQTT] Sent deployment to site2 (output_dir=/project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/fmaas_share/10)
Deploytime ACK from site2: {'site': 'site2', 'deploymentstatus': [{'status': 'loaded_momentbase', 'logger_summary': "{'load_backbone': {'wall time': 4372.327056000358, 'gpu time': 4372.41455078125, 'gpu peak': 455.474688, 'cpu dRSS': 544.03072}, 'add_decoder_ecgclass_momentbase_mlp': {'wall time': 12.028254001052119, 'gpu time': 12.056575775146484, 'gpu peak': 455.871488, 'cpu dRSS': 0.524288}}"}]}
[MQTT] Sent request chunk [0:3000] to site2
[MQTT] Sent request chunk [3000:6000] to site2
[MQTT] All 3600 requests sent to site2
Waiting for deployment ACKs from 1 sites...
Deployment phase complete. Results in /project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/fmaas_share/10

[Server] Deployment complete! Results in /project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/fmaas_share/10
INFO:     127.0.0.1:12662 - "POST /deploy HTTP/1.1" 200 OK

================================================================================
RUNTIME
================================================================================

INFO:     127.0.0.1:14618 - "POST /run HTTP/1.1" 200 OK
[Server] Starting inference in background thread...
Connecting to broker.emqx.io:8084 ...
Orchestrator connected to MQTT broker
Runtime start published to fmaas/runtime/start/site/site2
[Orchestrator] Runtime inference triggered (continuous mode)

[Server] Inference triggered (continuous mode - still running on site managers)

[Server] Adding task: gestureclass
         Type: classification, Workload: 8.0
         Elapsed time: 120.0s
[Orchestrator] Loading state from: /project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/fmaas_share/10/deployment_plan.json
[Orchestrator] Planned 'gestureclass' with share_mode=True. Diffs: [DeploymentDiff(action='add_decoder', site_manager='site2', server_name='device1', backbone='momentbase', ip='10.100.20.53:8000', device_type='NVIDIA A16', new_decoders=[{'task': 'gestureclass', 'type': 'classification', 'path': 'gestureclass_momentbase_mlp'}], full_deployment=None)]
[MQTT] Published /update to site2 (server=device1)
[Orchestrator] Waiting for ACKs from 1 site(s)...
Deploytime ACK from site2: {'site': 'site2', 'update': True, 'status': 'started'}[Orchestrator] All ACKs received for diff operation.

[Orchestrator] Saved updated state to /project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/fmaas_share/10/deployment_plan.json
  ✓ Deployment diff applied.
    add_decoder: device1 @ site2

[Server] Generating workload for new task (duration=240.0s, offset=120.0s)...
[Server] Using req_id_offset=3600
[Server] Applied time_offset=120.0s to 1920 requests
[Server] Generated 1920 requests (req_ids 3600 to 5519)
[Server] Time range: 120.0s to 360.0s
task_routes: {'gestureclass': [('site2', '10.100.20.53:8000', 'momentbase', 8.0)]}
task_totals: {'gestureclass': 8.0}
incoming_counts: {'gestureclass': 1920}
trace_duration: 240.0
1920
[Server] Sending new workload to site managers...
[Orchestrator] Sending 1920 new requests (total=5520)
[MQTT] Reusing existing MQTT connection (fast path)
[MQTT] Sent chunk [0:3000] to site2
[MQTT] All new requests sent.
  ✓ Workload sent!
INFO:     127.0.0.1:53704 - "POST /add-task HTTP/1.1" 200 OK
Runtime ACK from site2Runtime inference complete.

INFO:     127.0.0.1:53718 - "POST /wait HTTP/1.1" 200 OK

================================================================================
CLEANUP
================================================================================

Connecting to broker.emqx.io:8084 ...
Orchestrator connected to MQTT broker
Cleanup signal published to fmaas/cleanup/site/site2
Cleanup ACK from site2
Cleanup complete. All device servers killed.

[Server] Cleanup complete!
INFO:     127.0.0.1:57544 - "POST /cleanup HTTP/1.1" 200 OK

================================================================================
CLEANUP
================================================================================

INFO:     127.0.0.1:39528 - "POST /cleanup HTTP/1.1" 400 Bad Request
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [2805489]
