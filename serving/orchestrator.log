
╔═══════════════════════════════════════════════════════════════╗
║               FMaaS Orchestrator Server                       ║
╚═══════════════════════════════════════════════════════════════╝

Starting server on http://0.0.0.0:8080

Available endpoints:
  GET  /              - Health check
  GET  /status        - Get orchestrator status
  POST /deploy        - Deploy initial tasks
  POST /run           - Run inference
  POST /add-task      - Add task at runtime
  POST /cleanup       - Cleanup devices

Press Ctrl+C to stop

INFO:     Started server process [1216897]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
INFO:     127.0.0.1:40726 - "GET / HTTP/1.1" 200 OK

================================================================================
DEPLOYMENT
================================================================================

[Server] Loading config: runtime
[Server] Generating trace: lmsyschat (rate=10, duration=240s)
/home/hshastri_umass_edu/.conda/envs/fmtk/lib/python3.10/site-packages/torch/cuda/__init__.py:63: FutureWarning: The pynvml package is deprecated. Please install nvidia-ml-py instead. If you did not install pynvml directly, please report this to the maintainers of the package that installed pynvml for you.
  import pynvml  # type: ignore[import]
[Server] Generated 2400 requests
[Server] Planning deployment...
[Orchestrator] Saved deployment plan to /project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/fmaas_share/10/deployment_plan.json (scheduler=fmaas_share)
[Server] Routing trace...
task_routes: {'sysbp': [('site2', '10.100.20.55:8000', 'chronosbase', 6.854166666666666)], 'heartrate': [('site2', '10.100.20.55:8000', 'chronosbase', 2.2662839225096625), ('site2', '10.100.20.43:8000', 'chronosbase', 0.8795494108236709)]}
task_totals: {'sysbp': 6.854166666666666, 'heartrate': 3.1458333333333335}
incoming_counts: {'heartrate': 755, 'sysbp': 1645}
trace_duration: 240.0
2400
Connecting to broker.emqx.io:8084 ...
Orchestrator connected to MQTT broker
Publishing deployments + requests to all sites...
[Orchestrator] Sent 2400 requests (total=2400)
[MQTT] Sent deployment to site2 (output_dir=/project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/fmaas_share/10)
Deploytime ACK from site2: {'site': 'site2', 'error': 'Permission denied for user hshastri_umass_edu on host 10.100.20.55'}
Deploytime ACK from site2: {'site': 'site2', 'deploymentstatus': [{'status': 'loaded_chronosbase', 'logger_summary': "{'load_backbone': {'wall time': 4208.381756034214, 'gpu time': 4208.47900390625, 'gpu peak': 420.18304, 'cpu dRSS': 311.984128}, 'add_decoder_sysbp_chronosbase_mlp': {'wall time': 7.340834999922663, 'gpu time': 7.368415832519531, 'gpu peak': 420.577792, 'cpu dRSS': 0.0}, 'add_decoder_heartrate_chronosbase_mlp': {'wall time': 1.570550026372075, 'gpu time': 1.5983359813690186, 'gpu peak': 420.972544, 'cpu dRSS': 0.0}}"}, {'status': 'loaded_chronosbase', 'logger_summary': "{'load_backbone': {'wall time': 6375.042879022658, 'gpu time': 6375.20849609375, 'gpu peak': 420.18304, 'cpu dRSS': 309.972992}, 'add_decoder_heartrate_chronosbase_mlp': {'wall time': 11.231957993004471, 'gpu time': 11.29964828491211, 'gpu peak': 420.577792, 'cpu dRSS': 0.589824}}"}]}
[MQTT] Sent request chunk [0:3000] to site2
[MQTT] All 2400 requests sent to site2
Waiting for deployment ACKs from 1 sites...
Deployment phase complete. Results in /project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/fmaas_share/10

[Server] Deployment complete! Results in /project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/fmaas_share/10
INFO:     127.0.0.1:60946 - "POST /deploy HTTP/1.1" 200 OK

================================================================================
RUNTIME
================================================================================

INFO:     127.0.0.1:35828 - "POST /run HTTP/1.1" 200 OK
[Server] Starting inference in background thread...
Connecting to broker.emqx.io:8084 ...
Orchestrator connected to MQTT broker
Runtime start published to fmaas/runtime/start/site/site2
[Orchestrator] Runtime inference triggered (continuous mode)

[Server] Inference triggered (continuous mode - still running on site managers)

[Server] Adding task: ecgclass
         Type: classification, Workload: 8.0
         Elapsed time: 60.0s
[Orchestrator] Loading state from: /project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/fmaas_share/10/deployment_plan.json
[Orchestrator] Planned 'ecgclass' with share_mode=True. Diffs: [DeploymentDiff(action='add_decoder', site_manager='site2', server_name='device2', backbone='chronosbase', ip='10.100.20.43:8000', device_type='NVIDIA A16', old_backbone=None, new_decoders=[{'task': 'ecgclass', 'type': 'classification', 'path': 'ecgclass_chronosbase_mlp'}], full_deployment=None)]
[MQTT] Published /update to site2 (server=device2)
Deploytime ACK from site2: {'site': 'site2', 'update': True, 'status': 'started'}[Orchestrator] Waiting for ACKs from 1 site(s)...

Deploytime ACK from site2: {'site': 'site2', 'update': True, 'status': 'started'}
[Orchestrator] All ACKs received for diff operation.
[Orchestrator] Saved updated state to /project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/fmaas_share/10/deployment_plan.json
  ✓ Deployment diff applied.
    add_decoder: device2 @ site2

[Server] Generating workload for new task (duration=180.0s, offset=60.0s)...
[Server] Using req_id_offset=2400
[Server] Applied time_offset=60.0s to 1440 requests
[Server] Generated 1440 requests (req_ids 2400 to 3839)
[Server] Time range: 60.0s to 240.0s
task_routes: {'sysbp': [('site2', '10.100.20.55:8000', 'chronosbase', 6.854166666666666)], 'heartrate': [('site2', '10.100.20.55:8000', 'chronosbase', 2.2662839225096625), ('site2', '10.100.20.43:8000', 'chronosbase', 0.8795494108236709)], 'ecgclass': [('site2', '10.100.20.43:8000', 'chronosbase', 8.0)]}
task_totals: {'sysbp': 6.854166666666666, 'heartrate': 3.1458333333333335, 'ecgclass': 8.0}
incoming_counts: {'ecgclass': 1440}
trace_duration: 180.0
1440
[Server] Sending new workload to site managers...
[Orchestrator] Sending 1440 new requests (total=3840)
[MQTT] Reusing existing MQTT connection (fast path)
[MQTT] Sent chunk [0:3000] to site2
[MQTT] All new requests sent.
  ✓ Workload sent!
INFO:     127.0.0.1:39974 - "POST /add-task HTTP/1.1" 200 OK

[Server] Workload change: heartrate delta=+20.0 req/s
         Elapsed time: 120.0s
[Server] Generated 2400 additional requests for heartrate (t=120.0s → 240s)
task_routes: {'sysbp': [('site2', '10.100.20.55:8000', 'chronosbase', 6.854166666666666)], 'heartrate': [('site2', '10.100.20.55:8000', 'chronosbase', 2.2662839225096625), ('site2', '10.100.20.43:8000', 'chronosbase', 0.8795494108236709)], 'ecgclass': [('site2', '10.100.20.43:8000', 'chronosbase', 8.0)]}
task_totals: {'sysbp': 6.854166666666666, 'heartrate': 3.1458333333333335, 'ecgclass': 8.0}
incoming_counts: {'heartrate': 2400}
trace_duration: 120.0
409
[Orchestrator] Sending 409 new requests (total=4249)
[MQTT] Reusing existing MQTT connection (fast path)
[MQTT] Sent chunk [0:3000] to site2
[MQTT] All new requests sent.
  ✓ Workload spike sent!
[Orchestrator] Loading state from: /project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/fmaas_share/10/deployment_plan.json
[Orchestrator] Planned 'heartrate' with share_mode=True. Diffs: [DeploymentDiff(action='migrate', site_manager='site2', server_name='device1', backbone='chronossmall', ip='10.100.20.55:8000', device_type='NVIDIA A16', old_backbone='chronosbase', new_decoders=[{'task': 'sysbp', 'type': 'regression', 'path': 'sysbp_chronossmall_mlp'}, {'task': 'heartrate', 'type': 'regression', 'path': 'heartrate_chronossmall_mlp'}], full_deployment={'device': '10.100.20.55:8000', 'device_name': 'device1', 'device_type': 'NVIDIA A16', 'backbone': 'chronossmall', 'decoders': [{'task': 'sysbp', 'type': 'regression', 'path': 'sysbp_chronossmall_mlp'}, {'task': 'heartrate', 'type': 'regression', 'path': 'heartrate_chronossmall_mlp'}], 'tasks': {'sysbp': {'type': 'regression', 'total_requested_workload': 6.854166666666667, 'request_per_sec': 6.854166666666666}, 'heartrate': {'type': 'regression', 'total_requested_workload': 23.145833333333336, 'request_per_sec': 16.683452725009165}}, 'util': 0.8, 'mem': 16000}), DeploymentDiff(action='migrate', site_manager='site2', server_name='device2', backbone='chronossmall', ip='10.100.20.43:8000', device_type='NVIDIA A16', old_backbone='chronosbase', new_decoders=[{'task': 'heartrate', 'type': 'regression', 'path': 'heartrate_chronossmall_mlp'}, {'task': 'ecgclass', 'type': 'classification', 'path': 'ecgclass_chronossmall_mlp'}], full_deployment={'device': '10.100.20.43:8000', 'device_name': 'device2', 'device_type': 'NVIDIA A16', 'backbone': 'chronossmall', 'decoders': [{'task': 'heartrate', 'type': 'regression', 'path': 'heartrate_chronossmall_mlp'}, {'task': 'ecgclass', 'type': 'classification', 'path': 'ecgclass_chronossmall_mlp'}], 'tasks': {'heartrate': {'type': 'regression', 'total_requested_workload': 23.145833333333336, 'request_per_sec': 6.462380608324169}, 'ecgclass': {'type': 'classification', 'total_requested_workload': 8.0, 'request_per_sec': 8.0}}, 'util': 0.308813, 'mem': 16000})]
[MQTT] Published /migrate to site2 (server=device1, chronosbase → chronossmall)
[MQTT] Published /migrate to site2 (server=device2, chronosbase → chronossmall)
[Orchestrator] Waiting for ACKs from 1 site(s)...
Deploytime ACK from site2: {'site': 'site2', 'migrate': True, 'status': 'started'}[Orchestrator] All ACKs received for diff operation.

Deploytime ACK from site2: {'site': 'site2', 'migrate': True, 'status': 'started'}
[Orchestrator] Saved updated state to /project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/fmaas_share/10/deployment_plan.json
INFO:     127.0.0.1:51834 - "POST /add-workload HTTP/1.1" 200 OK
Deploytime ACK from site2: {'site': 'site2', 'migrate': True, 'status': 'started'}
Deploytime ACK from site2: {'site': 'site2', 'migrate': True, 'status': 'started'}

[Server] Adding task: gestureclass
         Type: classification, Workload: 8.0
         Elapsed time: 180.0s
[Orchestrator] Loading state from: /project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/fmaas_share/10/deployment_plan.json
[Orchestrator] Planned 'gestureclass' with share_mode=True. Diffs: [DeploymentDiff(action='add_decoder', site_manager='site2', server_name='device2', backbone='chronossmall', ip='10.100.20.43:8000', device_type='NVIDIA A16', old_backbone=None, new_decoders=[{'task': 'gestureclass', 'type': 'classification', 'path': 'gestureclass_chronossmall_mlp'}], full_deployment=None)]
[MQTT] Published /update to site2 (server=device2)
[Orchestrator] Waiting for ACKs from 1 site(s)...
Deploytime ACK from site2: {'site': 'site2', 'update': True, 'status': 'started'}[Orchestrator] All ACKs received for diff operation.

[Orchestrator] Saved updated state to /project/pi_shenoy_umass_edu/hshastri/FMaaS-motivation/serving/experiments/runtime/results/fmaas_share/10/deployment_plan.json
  ✓ Deployment diff applied.
    add_decoder: device2 @ site2

[Server] Generating workload for new task (duration=60.0s, offset=180.0s)...
[Server] Using req_id_offset=4249
Deploytime ACK from site2: {'site': 'site2', 'update': True, 'status': 'started'}
[Server] Applied time_offset=180.0s to 480 requests
[Server] Generated 480 requests (req_ids 4249 to 4728)
[Server] Time range: 180.0s to 240.0s
task_routes: {'sysbp': [('site2', '10.100.20.55:8000', 'chronossmall', 6.854166666666666)], 'heartrate': [('site2', '10.100.20.55:8000', 'chronossmall', 16.683452725009165), ('site2', '10.100.20.43:8000', 'chronossmall', 6.462380608324169)], 'ecgclass': [('site2', '10.100.20.43:8000', 'chronossmall', 8.0)], 'gestureclass': [('site2', '10.100.20.43:8000', 'chronossmall', 8.0)]}
task_totals: {'sysbp': 6.854166666666666, 'heartrate': 23.145833333333336, 'ecgclass': 8.0, 'gestureclass': 8.0}
incoming_counts: {'gestureclass': 480}
trace_duration: 60.0
480
[Server] Sending new workload to site managers...
[Orchestrator] Sending 480 new requests (total=4729)
[MQTT] Reusing existing MQTT connection (fast path)
[MQTT] Sent chunk [0:3000] to site2
[MQTT] All new requests sent.
  ✓ Workload sent!
INFO:     127.0.0.1:18350 - "POST /add-task HTTP/1.1" 200 OK
Runtime ACK from site2Runtime inference complete.

INFO:     127.0.0.1:18362 - "POST /wait HTTP/1.1" 200 OK

================================================================================
CLEANUP
================================================================================

Connecting to broker.emqx.io:8084 ...
Orchestrator connected to MQTT broker
Cleanup signal published to fmaas/cleanup/site/site2
Runtime ACK from site2
Cleanup ACK from site2
Cleanup complete. All device servers killed.

[Server] Cleanup complete!
INFO:     127.0.0.1:14092 - "POST /cleanup HTTP/1.1" 200 OK
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [1216897]
